@startuml System_Architecture
!theme plain
skinparam linetype ortho
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

title SingHealth Clinic Queue & Appointment Management System - Overall Architecture

' Define actors
actor Patient as patient
actor Staff as staff
actor Admin as admin

' Frontend Layer
package "Frontend Layer\n(React 19 + Vite)" {

    package "src/pages/" {
        component "PatientView.jsx" as patientView {
            [Appointment Booking]
            [Queue Check-in]
            [Profile Management]
        }

        component "StaffView.jsx" as staffView {
            [Queue Management]
            [Appointment Tracking]
            [Patient Check-in]
            [Doctor Management]
            [Daily Reports]
        }

        component "StaffDisplay.jsx" as staffDisplay {
            [Currently Serving Patient Display]
            [Waiting Queue List]
            [Missed Patients List]
            [Auto-refresh (5s)]
        }

        component "AdminView.jsx" as adminView {
            [User Management]
            [System Reports]
            [Clinic Configuration]
            [Backup & Restore]
        }

        component "AuthPage.jsx" as authPage {
            [Sign In]
            [Sign Up]
        }
    }


    package "src/components/" {
        component "Navbar.jsx" as navbar
        component "ProtectedRoute.jsx" as protectedRoute
        component "Toast.jsx" as toast
        component "LoadingSpinner.jsx" as spinner
        component "BackupManagement.jsx" as backup
    }


    package "src/contexts/" {
        component "AuthContext.jsx" as authContext
    }


    package "src/lib/" {
        component "api.js\n(HTTP Client)" as apiLayer
        component "supabase.js\n(Auth Client)" as supabaseClient
        component "supabaseAdmin.js\n(Admin Client)" as supabaseAdmin
    }
}

' Backend Layer
package "Backend Layer\n(Spring Boot 3.5.6 + Java 21)" {

    package "src/main/java/com/example/backend/controller/" as controllers {
        [AppointmentController] as apptCtrl
        [QueueController] as queueCtrl
        [AdminController] as adminCtrl
        [UserController] as userCtrl
        [NotificationController] as notifCtrl
        [ClinicController] as clinicCtrl
        [DoctorController] as doctorCtrl
        [ReportController] as reportCtrl
        [BackupController] as backupCtrl
        [HealthController] as healthCtrl
        [SystemUsageReportController] as sysReportCtrl
    }

    package "src/main/java/com/example/backend/service/" as services {
        [AppointmentService] as apptSvc
        [QueueService] as queueSvc
        [NotificationService] as notifSvc
        [PatientService] as patientSvc
        [StaffService] as staffSvc
        [UserService] as userSvc
        [ClinicService] as clinicSvc
        [DoctorService] as doctorSvc
        [ReportService] as reportSvc
        [BackupService] as backupSvc
        [QueueSseService] as sseSvc
        [SystemUsageReportService] as sysReportSvc
    }

    package "src/main/java/com/example/backend/repo/" as repositories {
        [AppointmentRepository] as apptRepo
        [QueueRepository] as queueRepo
        [PatientRepository] as patientRepo
        [StaffRepository] as staffRepo
        [UserRepository] as userRepo
        [ClinicRepository] as clinicRepo
        [DoctorRepository] as doctorRepo
    }

    package "src/main/java/com/example/backend/model/" as models {
        [User]
        [Patient]
        [Staff]
        [Doctor]
        [Clinic]
        [Appointment]
        [QueueLog]
    }

    package "src/main/java/com/example/backend/config/" as config {
        [SwaggerConfig]
        [SendGridConfig]
    }
}

' Database Layer
database "PostgreSQL Database\n(Supabase - AWS Singapore)" as db {
    frame "Tables" {
        [User]
        [Patient]
        [Staff]
        [Doctor]
        [Clinic]
        [Appointment]
        [QueueLog]
        [Reports]
    }
}

' External Services
cloud "External Services" {
    component "Supabase Auth\n(JWT Authentication)" as supabaseAuth
    component "SendGrid\n(Email Notifications)" as sendgrid
}

' Actor Connections
patient --> patientView
staff --> staffView
admin --> adminView

' Frontend Internal Connections
patientView --> authContext
patientView --> protectedRoute
patientView --> navbar
patientView --> toast
patientView --> spinner
staffView --> authContext
staffView --> protectedRoute
staffView --> navbar
staffView --> toast
staffView --> spinner
staffView --> backup
adminView --> authContext
adminView --> protectedRoute
adminView --> navbar
adminView --> toast
adminView --> spinner
adminView --> backup
staffDisplay --> authContext
staffDisplay --> navbar
staffDisplay --> spinner
authPage --> toast
authContext --> supabaseClient
authContext --> supabaseAdmin
navbar --> authContext
protectedRoute --> authContext
backup --> apiLayer

' Frontend Pages to API
patientView --> apiLayer
staffView --> apiLayer
adminView --> apiLayer
staffDisplay --> apiLayer
authPage --> apiLayer

' Shared Components to API
authContext --> supabaseClient : "Auth Requests"

' Frontend to Backend
apiLayer --> controllers : "HTTP/REST\n/api/*\nPort 8080"

' Controller to Service Layer
apptCtrl --> apptSvc
queueCtrl --> queueSvc
queueCtrl --> sseSvc : "SSE Streams"
adminCtrl --> patientSvc
adminCtrl --> staffSvc
userCtrl --> userSvc
notifCtrl --> notifSvc
clinicCtrl --> clinicSvc
doctorCtrl --> doctorSvc
reportCtrl --> reportSvc
reportCtrl --> sysReportSvc
sysReportCtrl --> sysReportSvc
backupCtrl --> backupSvc

' Service to Repository Layer
apptSvc --> apptRepo
apptSvc --> notifSvc
queueSvc --> queueRepo
queueSvc --> apptRepo
queueSvc --> notifSvc
patientSvc --> patientRepo
staffSvc --> staffRepo
userSvc --> userRepo
clinicSvc --> clinicRepo
doctorSvc --> doctorRepo
notifSvc --> sendgrid : "Email API"
backupSvc --> userRepo
backupSvc --> patientRepo
backupSvc --> staffRepo
backupSvc --> doctorRepo
backupSvc --> clinicRepo
backupSvc --> apptRepo
backupSvc --> queueRepo
sseSvc --> queueSvc
reportSvc --> apptRepo
reportSvc --> queueRepo
sysReportSvc --> apptRepo
sysReportSvc --> queueRepo

' Repository to Database
apptRepo --> db : "JPA/Hibernate\nJDBC"
queueRepo --> db
patientRepo --> db
staffRepo --> db
userRepo --> db
clinicRepo --> db
doctorRepo --> db
reportSvc --> db : "Query Reports"

' Backend to External Services
supabaseAuth --> db : "Auth Users Table"

' Notes
note right of controllers
  RESTful API Endpoints
  - HTTP Request Handling
  - Input Validation
  - Error Handling
  - Swagger Documentation
end note

note right of services
  Business Logic
  - Transaction Management
  - Validation Rules
  - DTO Conversion
  - Queue Algorithm
  - Double-Booking Prevention
  - Backup/Restore Operations
  - Report Generation
  - Real-time SSE Updates
end note

note right of repositories
  Data Access
  - Spring Data JPA
  - Custom Queries
  - Entity Management
  - Connection Pooling (HikariCP)
end note

note left of db
  Database Schema
  - JOINED Inheritance (User â†’ Patient, Staff)
  - 8 Main Tables
  - JSONB for Complex Data
  - Indexes for Performance
end note

note bottom of sendgrid
  Email Notifications:
  - Appointment Confirmation
  - Queue Position ("3 away")
  - Your Turn Alert
end note

note top of backupSvc
  Backup & Restore:
  - Full System Backup (ZIP + JSON)
  - Backup List & Details
  - Restore from Backup
  - Backup Download & Delete
  - Stored in ./backups directory
end note

note bottom of supabaseAuth
  Authentication:
  - JWT Tokens
  - Session Management
  - User Registration
  - Password Reset
end note

note right of staffDisplay
  Public Queue Display:
  - Large format for clinic waiting area (TV/Monitor)
  - Currently serving patient display
  - Real-time waiting queue list
  - Missed patients list
  - Auto-refresh every 5 seconds
end note

' Legend
legend bottom right
  |= Layer |= Responsibility |= Key Features |
  | Frontend | User Interface & Client-side Logic | React 19, Vite, Role-based Views |
  | Controllers | HTTP/REST API Endpoints | 11 Controllers, Swagger Docs, SSE Support |
  | Services | Business Logic & Transactions | 12 Services, Queue Algorithm, Backup System |
  | Repositories | Database Operations | Spring Data JPA, Custom Queries |
  | Database | Data Persistence | PostgreSQL, JOINED Inheritance, 8 Tables |
  | External | Authentication & Email Services | Supabase Auth, SendGrid Email |
endlegend

@enduml
